<link rel="import" href="../polymer/polymer.html">

<script src="../socket.io-client/dist/socket.io.js"></script>

<dom-module id="buttress-db-socket-io">
  <template>
    <style>
      :host {
        display: none;
      }
    </style>
  </template>
  <script>
    /**
     * `buttress-db-socket-io`
     * #
     *
     * @customElement
     * @polymer
     */
    class ButtressDbSocketIo extends Polymer.Element {
      static get is() { return 'buttress-db-socket-io'; }
      static get properties() {
        return {
          token: String,
          endpoint: String,
          appId: String,

          connected: {
            type: Boolean,
            value: false,
            notify: true
          },
          rxEvents: {
            type: Array,
            value: function() {
              return [
                'db-activity'
              ];
            }
          },
          tx: {
            type: Array,
            value: function() {
              return [];
            }
          },
          rx: {
            type: Array,
            value: function() {
              return [];
            }
          }
        };
      }
      static get observers() {
        return [
          '__tokenChanged(token)',
          '__tx(tx.splices)'
        ]
      }

      __tokenChanged() {
        const token = this.get('token');
        if (!token) {
          // io.disconnect();
          return;
        }

        this.connect();
      }

      connect() {
        const token = this.get('token');
        const appPublicId = this.get('appId');

        let uri = `${this.endpoint}`;
        if (appPublicId) {
          uri = `${this.endpoint}/${appPublicId}`;
        }

        console.log('debug', 'Attempting Socket connection', uri);
        try {
          this.socket = io.connect(uri, {
            query: {
              token: token
            }
          });
          this.socket.on('connect',() => {
            this.connected = true;
            console.log('debug', 'Connected');
            this.__configureRxEvents();
          });
          this.socket.on('disconnect',() => {
            this.connected = false;
          });
        } catch (err) {
          console.log('err', err);
          this.dispatchEvent(new CustomEvent('error', {detail: err, bubbles: true, composed: true}));
        }
      }

      __configureRxEvents() {
        this.rxEvents.forEach(ev => {
          console.log('debug', '__configureRxEvents', ev);
          this.socket.on(ev, (data) => {
            console.log('debug', 'rxEvents:');
            console.log('debug', data);
            this.dispatchEvent(new CustomEvent('rx-event', {
              detail: Object.assign({}, { type: ev, payload: data }),
              bubbles: true
            }));
          });
        });
      }

      __tx(cr) {
        if (!this.socket) {
          return;
        }

        console.log('debug', cr);

        cr.indexSplices.forEach(i => {
          if (i.type !== 'splice' || i.addedCount === 0) {
            return;
          }
          console.log('debug', 'tx.added');

          for (let x=0; x<i.addedCount; x++) {
            let o = i.object[x+i.index];
            console.log('debug', `emitting: ${o.type}`);
            this.socket.emit(o.type, o.payload);
          }
        });
      }
    }
    window.customElements.define(ButtressDbSocketIo.is, ButtressDbSocketIo);
  </script>
</dom-module>